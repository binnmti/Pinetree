@page "/{UserName}/Edit/{id:long}"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Pinetree.Components.Components
@using Pinetree.Components.Services
@using Pinetree.Data
@using Pinetree.Model
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
 
@rendermode InteractiveServer

@if (PineTree != null)
{
    <Markdown UserName="@(UserName)" PineTree="@(PineTree)" Id="@(Id)" IsTry="@(true)" FileCount=@FileCount />
}

@code {
    [Parameter]
    public string UserName { get; set; } = "";

    [Parameter]
    public long Id { get; set; }

    private PineTree PineTree { get; set; } = new PineTree(0, "", "", null, 0);
    private int FileCount { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var identity = await AuthenticationStateProvider.GetIdentityAsync();
        if (identity == null || identity.Name != UserName)
        {
            Navigation.NavigateTo("/");
            return;
        }
        var hit = await DbContext.SingleIncludeChildAsync(Id);
        if (hit == null)
        {
            Navigation.NavigateTo("/");
            return;
        }
        (PineTree, FileCount) = hit.ToPineTreeIncludeChild();
    }
}
