@page "/Account/Manage/Plan"
@using System.Diagnostics
@using Microsoft.AspNetCore.Identity
@using Pinetree.Data
@using Pinetree.Services
@using Pinetree.Shared
@using System.ComponentModel.DataAnnotations

@inject IdentityUserAccessor UserAccessor
@inject SignInManager<ApplicationUser> SignInManager

<PageTitle>Manage Plan</PageTitle>

<h3>Manage Plan</h3>

<StatusMessage Message="@message" />
<div class="row">
    <div class="col-xl-6">
        <!-- Free Offer Form -->
        @if (IsFree && !HasSpecialAccess)
        {
            <form @onsubmit="ClaimFreeOffer" @formname="free-offer" method="post">
                <AntiforgeryToken />
                <div class="form-floating mb-3 input-group">
                    <input type="text" value="@role" id="plan" class="form-control" placeholder="Enter your email" disabled />
                    <label for="plan" class="form-label">Plan</label>
                </div>
                
                <div class="alert alert-success mb-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-gift-fill me-2"></i>
                        <span><strong>Limited Time Offer:</strong> Get 1 year of Professional Plan absolutely FREE!</span>
                    </div>
                </div>
                <button type="submit" class="w-100 btn btn-lg btn-success mb-3">
                    <i class="bi bi-lightning-fill"></i> Claim Your 1 Year FREE Access
                </button>
            </form>
            
            <div class="text-center mb-3">
                <small class="text-muted">— or choose your support amount —</small>
            </div>
        }
        
        <!-- Main Form -->
        <form @onsubmit="OnSubmit" @formname="send-verification" id="send-verification-form" method="post">
            <AntiforgeryToken />
            @if (!IsFree || HasSpecialAccess)
            {
                <div class="form-floating mb-3 input-group">
                    <input type="text" value="@role" id="plan-main" class="form-control" placeholder="Enter your email" disabled />
                    <label for="plan-main" class="form-label">Plan</label>
                </div>
            }
            
            @if (IsFree)
            {
                @if (HasSpecialAccess)
                {
                    <div class="alert alert-info mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <span>@GetSpecialAccessMessage(SpecialAccessType!)</span>
                        </div>
                    </div>
                    <button type="submit" class="w-100 btn btn-lg btn-primary mb-3">
                        @(IsReturningCustomer ? "Reactivate Pro Plan" : "Activate Your Special Access")
                    </button>
                }
                else
                {
                    <!-- Custom Amount Input Section -->
                    <div class="mb-3">
                        <label for="customAmount" class="form-label">Support Amount (USD/month)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="customAmount" 
                                   name="customAmount"
                                   value="@customAmount"
                                   @oninput="OnAmountChanged"
                                   min="1" 
                                   step="1" 
                                   placeholder="1.00" 
                                   required />
                            <span class="input-group-text">/month</span>
                        </div>
                        <small class="form-text text-muted">
                            Minimum: $1/month. Your support helps us improve Pinetree!
                        </small>
                        <div class="alert alert-warning mt-2 small">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <strong>Important:</strong> Once you subscribe, you cannot change the amount directly in Stripe. 
                            Please choose your amount carefully.
                            (If you need to adjust your support amount, please contact us through the <a href="/feedback" class="alert-link">Feedback</a> page.)
                        </div>
                    </div>

                    <button type="submit" class="w-100 btn btn-lg btn-primary">
                        @(IsReturningCustomer ? "Reactivate Pro Plan" : "Upgrade to Pro Plan") - $@customAmount/month
                    </button>
                }
            }
            else
            {
                <div>
                    <button type="submit" class="w-100 btn btn-lg btn-primary">Manage Billing & Invoices</button>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Opens Stripe secure billing portal in a new window
                        </small>
                    </div>
                </div>
            }
        </form>
    </div>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;
    [Inject]
    public required PaymentService PaymentService { get; set; }
    [Inject]
    public required UserManager<ApplicationUser> UserManager { get; set; }
    [Inject]
    public required NavigationManager NavigationManager { get; set; }
    
    private string message = "";
    private string? role;
    private bool IsFree;
    private bool IsReturningCustomer;
    private bool HasSpecialAccess;
    private string? SpecialAccessType;
    private decimal customAmount = 1;
    
    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        
        if (query.TryGetValue("payment", out var paymentStatus))
        {            
            if (paymentStatus == "success")
            {
                message = "Your payment was successful. Thank you for your support!";
            }
            else if (paymentStatus == "cancel")
            {
                message = "Payment was cancelled. You can try again anytime.";
            }
        }
        
        if (query.TryGetValue("upgrade", out var upgradeStatus))
        {
            if (upgradeStatus == "success")
            {
                query.TryGetValue("type", out var accessType);
                message = $"Your Professional Plan has been activated successfully! {GetSpecialAccessThankYouMessage(accessType)}";
            }
        }

        var currentUser = await UserAccessor.GetRequiredUserAsync(HttpContext);
        var roles = await UserManager.GetRolesAsync(currentUser);
        Debug.Assert(roles.Count <= 1, "User has more than one role assigned");
        role = roles.FirstOrDefault() ?? "Free";
        IsFree = role == null ? true : Roles.IsFree(role);
        IsReturningCustomer = IsFree && !string.IsNullOrEmpty(currentUser.StripeCustomerId);
        
        SpecialAccessType = currentUser.SpecialAccessType;
        HasSpecialAccess = !string.IsNullOrEmpty(SpecialAccessType) && IsFree;
    }
    
    private void OnAmountChanged(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var amount) && amount >= 1)
        {
            customAmount = amount;
        }
    }
    
    private async Task ClaimFreeOffer()
    {
        var url = await PaymentService.CreateCheckoutSessionAsync();
        NavigationManager.NavigateTo(url);
    }
    
    private async Task OnSubmit()
    {
        if (HasSpecialAccess && IsFree)
        {
            var specialUrl = await PaymentService.CreateCheckoutSessionAsync();
            NavigationManager.NavigateTo(specialUrl);
            return;
        }

        // Get the custom amount from the form data
        decimal amount = customAmount; // Use the bound value
        
        if (HttpContext.Request.HasFormContentType)
        {
            var form = await HttpContext.Request.ReadFormAsync();
            if (form.TryGetValue("customAmount", out var amountValue) && 
                decimal.TryParse(amountValue, out var parsedAmount))
            {
                amount = parsedAmount;
            }
        }

        string url;

        if (IsFree)
        {
            if (IsReturningCustomer)
            {
                url = await PaymentService.CreatePortalSession();
            }
            else
            {
                url = await PaymentService.CreateCustomAmountCheckoutSessionAsync(amount);
            }
        }
        else
        {
            url = await PaymentService.CreatePortalSession();
        }

        NavigationManager.NavigateTo(url);
    }
    
    private string GetSpecialAccessMessage(string accessType)
    {
        return accessType switch
        {
            "feedback_free" => "Thank you for your feedback! You've been granted free access to the Professional Plan.",
            _ => "You have special access to the Professional Plan."
        };
    }

    private string GetSpecialAccessThankYouMessage(string? accessType)
    {
        return accessType switch
        {
            "feedback_free" => "Thank you for being an early supporter!",
            _ => "Welcome to Professional Plan!"
        };
    }
}